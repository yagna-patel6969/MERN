<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaskMaster - Your Personal Task Manager</title>
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/components.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container">
      <a href="index.html" class="navbar-brand" style="cursor: pointer; text-decoration: none;">âœ“ TaskMaster</a>
      
      <button class="menu-toggle">â˜°</button>
      
      <ul class="navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="analytics.html">Analytics</a></li>
        <li><a href="team.html">Team</a></li>
        <li><a href="leaderboard.html">Leaderboard</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li id="user-info"></li>
        <li><button id="theme-toggle" class="theme-toggle">ğŸŒ™</button></li>
        <li><button id="logout-btn" class="btn btn-sm btn-secondary">Logout</button></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      <!-- Header Section -->
      <div class="flex-between mb-4">
        <div>
          <h1>My Tasks</h1>
          <p class="text-secondary">Organize your day, achieve your goals</p>
        </div>
        <div class="flex gap-2">
          <button id="add-task-btn" class="btn btn-primary">+ Add Task</button>
          <button id="export-calendar-btn" class="btn btn-secondary">ğŸ“… Export to Calendar</button>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="grid grid-4 mb-4">
        <div class="stats-card">
          <div class="stats-value" id="total-tasks">0</div>
          <div class="stats-label">Total Tasks</div>
        </div>
        <div class="stats-card">
          <div class="stats-value" id="completed-tasks">0</div>
          <div class="stats-label">Completed</div>
        </div>
        <div class="stats-card">
          <div class="stats-value" id="pending-tasks">0</div>
          <div class="stats-label">Pending</div>
        </div>
        <div class="stats-card">
          <div class="stats-value" id="overdue-tasks">0</div>
          <div class="stats-label">Overdue</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="card mb-4">
        <div class="flex-between gap-2" style="flex-wrap: wrap;">
          <div class="flex gap-2" style="flex-wrap: wrap;">
            <button class="btn btn-sm btn-secondary filter-btn active" data-filter="all">All</button>
            <button class="btn btn-sm btn-secondary filter-btn" data-filter="pending">Pending</button>
            <button class="btn btn-sm btn-secondary filter-btn" data-filter="completed">Completed</button>
            <button class="btn btn-sm btn-secondary filter-btn" data-filter="today">Today</button>
            <button class="btn btn-sm btn-secondary filter-btn" data-filter="overdue">Overdue</button>
          </div>
          <input type="text" id="search-input" class="form-input" placeholder="ğŸ” Search tasks..." style="max-width: 300px;">
        </div>
      </div>

      <!-- Task Categories -->
      <div class="grid grid-2 gap-3">
        <!-- Today's Timetable -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ“… Today's Timetable</h3>
          </div>
          <div id="timetable-container"></div>
        </div>

        <!-- Upcoming Tasks -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">â° Upcoming Tasks</h3>
          </div>
          <div id="upcoming-container"></div>
        </div>
      </div>

      <!-- All Tasks -->
      <div class="card mt-4">
        <div class="card-header">
          <h3 class="card-title">All Tasks</h3>
        </div>
        <div id="tasks-container"></div>
      </div>
    </div>
  </main>

  <!-- Add Task Modal -->
  <div id="add-task-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Add New Task</h2>
        <button class="modal-close" onclick="closeModal('add-task-modal')">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="add-task-form">
          <div class="form-group">
            <label class="form-label">Task Title *</label>
            <input type="text" id="task-title" class="form-input" placeholder="Enter task title" required>
          </div>

          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea id="task-description" class="form-textarea" placeholder="Add details..."></textarea>
          </div>

          <div class="grid grid-2 gap-2">
            <div class="form-group">
              <label class="form-label">Category</label>
              <select id="task-category" class="form-select">
                <option value="work">ğŸ’¼ Work</option>
                <option value="personal">ğŸ‘¤ Personal</option>
                <option value="shopping">ğŸ›’ Shopping</option>
                <option value="health">ğŸ’ª Health</option>
                <option value="finance">ğŸ’° Finance</option>
                <option value="learning">ğŸ“š Learning</option>
                <option value="social">ğŸ‘¥ Social</option>
                <option value="other">ğŸ“Œ Other</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Priority</label>
              <select id="task-priority" class="form-select">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>

          <div class="grid grid-2 gap-2">
            <div class="form-group">
              <label class="form-label">Due Date</label>
              <input type="date" id="task-date" class="form-input">
            </div>

            <div class="form-group">
              <label class="form-label">Due Time</label>
              <input type="time" id="task-time" class="form-input">
            </div>
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="task-reminder" style="width: auto;">
              <span>Set reminder for this task</span>
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('add-task-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveTask()">Add Task</button>
      </div>
    </div>
  </div>

  <!-- Export Options Modal -->
  <div id="export-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“… Export to Calendar</h2>
        <button class="modal-close" onclick="closeModal('export-modal')">Ã—</button>
      </div>
      <div class="modal-body">
        <p class="text-secondary mb-3">Choose which tasks to export to your calendar:</p>
        <div class="grid gap-2">
          <button class="btn btn-primary" onclick="exportTasksToCalendar('all')" style="width: 100%;">
            ğŸ“‹ Export All Tasks
          </button>
          <button class="btn btn-secondary" onclick="exportTasksToCalendar('pending')" style="width: 100%;">
            â³ Export Pending Tasks Only
          </button>
          <button class="btn btn-secondary" onclick="exportTasksToCalendar('completed')" style="width: 100%;">
            âœ… Export Completed Tasks Only
          </button>
          <button class="btn btn-secondary" onclick="exportTasksToCalendar('today')" style="width: 100%;">
            ğŸ“… Export Today's Tasks
          </button>
        </div>
        <div class="alert alert-info mt-3">
          <strong>ğŸ’¡ How to import:</strong><br>
          1. Download the .ics file<br>
          2. Open Google Calendar<br>
          3. Click Settings â†’ Import & Export<br>
          4. Upload the downloaded file
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('export-modal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/theme.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/tasks.js"></script>
  <script src="js/calendar.js"></script>
  <script src="js/analytics.js"></script>
  <script src="js/notifications.js"></script>
  <script src="js/app.js"></script>
  <script src="js/gamification.js"></script>
  
  <script>
    // Check authentication
    if (!authManager.requireAuth()) {
      // Will redirect to auth.html
    }

    let currentFilter = 'all';
    let searchQuery = '';

    // Initialize page
    function initPage() {
      loadStats();
      loadTimetable();
      loadUpcomingTasks();
      loadTasks();
    }

    // Load statistics
    function loadStats() {
      const allTasks = taskManager.getTasks();
      const completed = allTasks.filter(t => t.completed).length;
      const pending = allTasks.filter(t => !t.completed).length;
      const overdue = taskManager.getOverdueTasks().length;

      document.getElementById('total-tasks').textContent = allTasks.length;
      document.getElementById('completed-tasks').textContent = completed;
      document.getElementById('pending-tasks').textContent = pending;
      document.getElementById('overdue-tasks').textContent = overdue;
    }

    // Load today's timetable
    function loadTimetable() {
      const timetable = calendarManager.getTodayTimetable();
      const container = document.getElementById('timetable-container');

      if (timetable.length === 0) {
        container.innerHTML = '<div class="empty-state"><p class="text-muted">No tasks scheduled for today</p></div>';
        return;
      }

      container.innerHTML = timetable.map(task => `
        <div class="task-card ${task.category} ${task.completed ? 'completed' : ''}" onclick="toggleTask('${task.id}')">
          <div class="task-header">
            <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} onclick="event.stopPropagation(); toggleTask('${task.id}')">
            <div class="task-title">${task.title}</div>
            ${task.priority ? `<span class="task-priority ${task.priority}">${task.priority}</span>` : ''}
          </div>
          <div class="task-meta">
            ${task.dueTime ? `<span>â° ${app.formatTime(task.dueTime)}</span>` : ''}
            <span class="task-category"><span class="category-dot" style="background: var(--task-${task.category})"></span>${task.category}</span>
          </div>
        </div>
      `).join('');
    }

    // Load upcoming tasks
    function loadUpcomingTasks() {
      const upcoming = taskManager.getUpcomingTasks(7);
      const container = document.getElementById('upcoming-container');

      if (upcoming.length === 0) {
        container.innerHTML = '<div class="empty-state"><p class="text-muted">No upcoming tasks</p></div>';
        return;
      }

      container.innerHTML = upcoming.slice(0, 5).map(task => `
        <div class="task-card ${task.category}" onclick="toggleTask('${task.id}')">
          <div class="task-header">
            <input type="checkbox" class="task-checkbox" onclick="event.stopPropagation(); toggleTask('${task.id}')">
            <div class="task-title">${task.title}</div>
          </div>
          <div class="task-meta">
            <span>ğŸ“… ${app.formatDate(task.dueDate)}</span>
          </div>
        </div>
      `).join('');
    }

    // Load all tasks
    function loadTasks() {
      let tasks = taskManager.getTasks();

      // Apply filters
      if (currentFilter === 'pending') {
        tasks = tasks.filter(t => !t.completed);
      } else if (currentFilter === 'completed') {
        tasks = tasks.filter(t => t.completed);
      } else if (currentFilter === 'today') {
        const today = new Date().toISOString().split('T')[0];
        tasks = tasks.filter(t => t.dueDate === today);
      } else if (currentFilter === 'overdue') {
        tasks = taskManager.getOverdueTasks();
      }

      // Apply search
      if (searchQuery) {
        tasks = tasks.filter(t => 
          t.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
          (t.description && t.description.toLowerCase().includes(searchQuery.toLowerCase()))
        );
      }

      const container = document.getElementById('tasks-container');

      if (tasks.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><h3 class="empty-state-title">No tasks found</h3><p class="empty-state-text">Create your first task to get started!</p></div>';
        return;
      }

      container.innerHTML = tasks.map(task => `
        <div class="task-card ${task.category} ${task.completed ? 'completed' : ''}" onclick="toggleTask('${task.id}')">
          <div class="task-header">
            <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} onclick="event.stopPropagation(); toggleTask('${task.id}')">
            <div class="task-title">${task.title}</div>
            ${task.priority ? `<span class="task-priority ${task.priority}">${task.priority}</span>` : ''}
          </div>
          ${task.description ? `<p class="text-secondary" style="margin: 0.5rem 0 0 2rem; font-size: 0.875rem;">${task.description}</p>` : ''}
          <div class="task-meta" style="margin-left: 2rem;">
            ${task.dueDate ? `<span>ğŸ“… ${app.formatDate(task.dueDate)}</span>` : ''}
            ${task.dueTime ? `<span>â° ${app.formatTime(task.dueTime)}</span>` : ''}
            <span class="task-category"><span class="category-dot" style="background: var(--task-${task.category})"></span>${task.category}</span>
          </div>
        </div>
      `).join('');
    }

    // Toggle task completion
    function toggleTask(taskId) {
      const result = taskManager.toggleTaskComplete(taskId);
      if (result.success) {
        initPage();
      }
    }

    // Modal functions
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // Save task
    function saveTask() {
      const title = document.getElementById('task-title').value;
      const description = document.getElementById('task-description').value;
      const category = document.getElementById('task-category').value;
      const priority = document.getElementById('task-priority').value;
      const dueDate = document.getElementById('task-date').value;
      const dueTime = document.getElementById('task-time').value;
      const reminder = document.getElementById('task-reminder').checked;

      const result = taskManager.createTask({
        title,
        description,
        category,
        priority,
        dueDate,
        dueTime,
        reminder
      });

      if (result.success) {
        closeModal('add-task-modal');
        document.getElementById('add-task-form').reset();
        initPage();
        
        notificationManager.showNotification({
          title: 'Task Created',
          message: `"${title}" has been added to your tasks`,
          type: 'success'
        });
      }
    }

    // Export to calendar - open modal
    function exportToCalendar() {
      openModal('export-modal');
    }

    // Export tasks to calendar with filter
    function exportTasksToCalendar(filter) {
      let tasks = taskManager.getTasks();
      
      // Apply filter
      if (filter === 'pending') {
        tasks = tasks.filter(t => !t.completed);
      } else if (filter === 'completed') {
        tasks = tasks.filter(t => t.completed);
      } else if (filter === 'today') {
        const today = new Date().toISOString().split('T')[0];
        tasks = tasks.filter(t => t.dueDate === today);
      }

      // Generate ICS content
      const icsContent = calendarManager.exportTasksToICS(tasks);
      const filename = `taskmaster-${filter}-tasks.ics`;
      calendarManager.downloadICS(icsContent, filename);
      
      closeModal('export-modal');
      
      notificationManager.showNotification({
        title: 'Calendar Exported',
        message: `${tasks.length} task(s) exported. Import the file to Google Calendar.`,
        type: 'success'
      });
    }

    // Event listeners
    document.getElementById('add-task-btn').addEventListener('click', () => openModal('add-task-modal'));
    document.getElementById('export-calendar-btn').addEventListener('click', exportToCalendar);
    document.getElementById('logout-btn').addEventListener('click', () => authManager.logout());

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        loadTasks();
      });
    });

    // Search
    document.getElementById('search-input').addEventListener('input', (e) => {
      searchQuery = e.target.value;
      loadTasks();
    });

    // Modal overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.style.display = 'none';
        }
      });
    });

    // Initialize
    initPage();
  </script>
</body>
</html>
